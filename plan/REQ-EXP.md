# REQ-EXP: Baseline Expiration

This document describes the requirements for baseline expiration, a feature that ensures probabilistic tests operate against empirically fresh data and alerts operators when baselines approach or exceed their intended validity period.

Baseline staleness is a significant operational problem. Systems change, dependencies update, and infrastructure drifts—often without explicit notification. A simple, low-overhead mechanism to surface stale baselines provides high value with minimal complexity.

---

## 1. Declaring expiration at experiment definition time

The `@Experiment` annotation receives a new attribute:

- **`expiresInDays`**

This attribute specifies the number of days for which a baseline generated by this experiment should be considered valid.

- **Default value:** no expiration (represented as `0` or a sentinel value)
- **Type:** integer (non-negative)

When `expiresInDays` is not set (or set to the default), the baseline does not expire. However, PUnit may emit a **one-time informational note** during MEASURE execution suggesting that the experimenter consider setting an expiration policy. This note is non-intrusive and does not repeat on subsequent test runs.

When a positive value is set, it represents the experimenter's explicit statement of how long they believe the baseline's empirical data remains representative of the system's behavior.

### Rationale for opt-in expiration

Making expiration opt-in rather than mandatory:

- Avoids warning fatigue for stable systems that genuinely don't drift
- Ensures experimenters consciously choose to enable expiration tracking
- Keeps PUnit unobtrusive for simple use cases while providing guardrails for those who need them

---

## 2. Capturing expiration policy in baseline specs

When a MEASURE experiment is executed, the value of `expiresInDays` is captured as part of the resulting baseline specification file.

This ensures that:

- The expiration policy is permanently associated with the baseline artifact.
- The policy in effect at baseline creation time is preserved (not retroactively changed).
- The baseline spec contains all information needed to evaluate validity at test time.

The baseline spec should record:

- The `expiresInDays` value (or explicit "no expiration" indicator).
- The baseline creation timestamp—specifically, the **end time** of the experiment (when the last sample was collected).
- Optionally, a computed expiration date for convenience (if expiration is enabled).

### Timestamp semantics

Expiration is computed from the **end** of the experiment execution, not the start. For long-running experiments, this ensures the expiration reflects when the empirical data was fully collected, not when collection began.

All timestamps should be stored in UTC with timezone metadata to ensure correct computation across different execution environments.

---

## 3. Evaluating baseline validity at probabilistic test time

When a spec'ed probabilistic test executes, the report builder:

1. Reads the test's associated baseline specification file.
2. Checks whether an expiration policy is defined.
3. If defined, retrieves the baseline end timestamp and `expiresInDays` value.
4. Computes whether the baseline has expired relative to the current execution time.

A baseline is considered **expired** if:

```
currentTime > baselineEndTime + expiresInDays
```

If no expiration policy is defined, no expiration check is performed.

---

## 4. Reporting expired baselines

If a baseline is determined to be expired:

- A **prominent warning** is added to the test verdict.
- This warning is displayed **irrespective of the verbosity level** configured for the report.

The warning should clearly state:

- That the baseline has expired.
- When the baseline was created (end timestamp).
- The expiration date.
- How long ago it expired (days past expiration).
- That the statistical inference is based on potentially stale empirical data.

Expiration does not alter pass/fail semantics; it qualifies the inference with a clear operational signal that fresh data collection is warranted.

---

## 5. Pre-expiration warnings

In the period leading up to the expiration date, PUnit adds **friendly warnings** to the report to forewarn operators of upcoming expiration.

### Proportional thresholds

Rather than fixed day thresholds, warnings are triggered based on the **percentage of validity period remaining**:

| Remaining validity | Warning level |
|--------------------|---------------|
| ≤ 25% remaining    | Informational: "Baseline expires soon" |
| ≤ 10% remaining    | Warning: "Baseline expiring imminently" |

For example, with a 30-day expiration:
- 25% threshold triggers at 7.5 days remaining
- 10% threshold triggers at 3 days remaining

For a 90-day expiration:
- 25% threshold triggers at 22.5 days remaining
- 10% threshold triggers at 9 days remaining

This ensures warnings scale appropriately regardless of the validity period.

### Warning characteristics

Pre-expiration warnings should:

- Be less prominent than the expired warning.
- Clearly state the remaining validity period and expiration date.
- Encourage proactive baseline refresh.

This allows operators to schedule re-measurement before the baseline becomes stale.

---

## 6. Interaction with REQ-COV (Covariates)

Expiration and covariate non-conformance are **independent conditions**, and both are evaluated when applicable.

| Condition | Meaning |
|-----------|---------|
| Covariate non-conformance | Test context differs from baseline context (detectable mismatch) |
| Expiration | Baseline data is old (possible undetectable drift) |

A baseline may be:
- Expired but covariate-conformant
- Non-expired but covariate-non-conformant
- Both expired and non-conformant
- Neither (fully valid)

When both conditions apply, both warnings are surfaced in the report. They are complementary guardrails:

- **Covariates** catch known, observable context changes.
- **Expiration** catches unknown drift that accumulates over time.

Together they provide defense in depth against population mismatch.

---

## 7. Out of scope

External monitoring mechanisms (e.g., cron jobs that inspect baseline files and alert operators proactively) are outside the scope of PUnit.

PUnit provides the information (expiration dates, timestamps) in machine-readable formats that external tooling can consume, but does not itself implement scheduled alerting or notifications.

---

## 8. Summary

The baseline expiration feature ensures that:

- Experimenters can explicitly declare how long their baselines remain representative.
- Expiration is opt-in, avoiding warning fatigue for stable systems.
- Baseline specs carry their validity period as immutable metadata.
- Probabilistic tests transparently report when they rely on expired data.
- Operators receive proportional advance warning before baselines expire.
- Expiration warnings complement covariate warnings as layered protection.
- Statistical inference remains honest about the freshness of its empirical foundation.

This reinforces PUnit's commitment to treating temporal validity as a managed, reported, and auditable condition of probabilistic testing.
